### PJT-2
#### 2024-01-18

- [x] AWS Ec2 설정
- [x] CI/CD 구조 확인
- [x] Ec2 서버에 Jenkins, Docker 설치

<br>

## CI / CD
### CI (Continuous Integration)
- 여러 명의 많은 개발자들이 코드 베이스를 계속해서 통합하는 것
- 여러 개발자들의 코드를 각각 가능한 빠르게 배포를 하는 것을 의미

### CD (Continuous Delivery/Deployment)
- Delivery : 내부 사용자(내부 QA, 마케터, 기획자)든, 사용자든 서비스를 지속적으로 배달
<br> 코드 베이스가 항상 배포 가능한 상태를 유지하는 것을 의미
- Deployment : 코드 베이스를 사용자가 사용 가능한 환경에 배포하는 것을 자동화하는 것


<br>

## Jenkins
소프트웨어 개발 시 지속적 통합 서비스를 제공하는 툴<br>
여러 개발자가 함께 작성하는 경우 모든 커밋을 일일이 확인하는 작업 필요
<br> -> 코드를 커밋하기 전 해당 코드의 동작 여부 알수 었을까?

장점
- 모듈 형태라 대부분의 다른 툴과 함께 사용 가능
- 오픈소스이기 때문에 사용자의 입맛에 따라 설정 가능 (플러그인 1000개 이상)

흐름
- 개발자가 repository에 변경사항 commit
- Jenkins의 CI 서버는 정기적으로 repository를 확인해 새로운 코드 가져옴
- 빌드 서버는 코드를 실행 파일로 빌드, 빌드 실패 시 개발자에게 알림 전송
- Jenkins는 빌드된 어플리케이션을 설정된 서버에 배포, 실패 시 개발자에게 알림 전송
- 최종적으로 문제 없다면 프로덕션 서버에 배포

<br>

## docker
애플리케이션을 신속하게 구축, 테스트 및 배포할 수 있는 소프트웨어 플랫폼

Container? <br>
가상화된 공간을 생성하기 위해 Linux 자체 기능인 chroot, namespace, cgroup을 사용한
Process 단위의 독립 공간 <br>
Container 안에는 Application 구동을 위해 필요한 파일만 존재

장점 <br>
Application의 개발과 배포가 편해진다.
- 독립된 개발 환경 보장 <br>
    Container는 격리된 공간이므로 그 자체에 특별한 권한을 주지 않는 한 내부에서 무엇을 하든 Host OS에는 영향을 끼치지 않는다.
- 개발/운영 환경의 통합 <br>
    Container 내부 작업을 배포하기 위해서는 해당 Container를 docker image라는 하나의 패키지로 만들어 운영 서버에 전달하기만 하면 된다 <br>
    서비스를 개발했을 때의 환경을 다른 서버에서도 똑같이 복제할 수 있기 때문에 각종 라이브러리 설치 등으로 인한 의존성을 걱정할 필요가 없다.
- 배포 신속성 및 H/W 효율 <br>
    Kernel을 포함하고 있지 않기 때문에 image 크기가 비교적 작다 <br>
    Application의 배포 속도가 매우 빨라지며, H/W 용량을 작게 차지
<br>

여러 Application의 독립성과 확장성이 높아진다
- Monolith Architecture <br>
    여러 Module이 상호 작용하는 로직을 하나의 프로그램 내에서 구동 <br>
    기능이 복잡한 대규모 서비스에서는 확장성과 유연성이 떨어진다는 단점
- Microservice Architecture <br>
    여러 Module을 독립된 형태로 구성하므로 언어에 종속되지 않으며 변화에 빠르게 대응 <br>
    독립된 형태들을 구현하는 데에 주로 Docker Container 가 많이 사용

<br>

## Ec2에 Jenkins, Docker 환경 세팅

### Jenkins 설치

[Jenkins 공식 문서](https://www.jenkins.io/doc/tutorials/tutorial-for-installing-jenkins-on-AWS/#downloading-and-installing-jenkins) &nbsp;&nbsp;
[참고 블로그](https://velog.io/@haeny01/AWS-Jenkins%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-Docker-x-SpringBoot-CICD-%EA%B5%AC%EC%B6%95#-%EB%AA%A9%ED%91%9C)

```
[ec2-user ~]$ sudo apt update
[ec2-user ~]$ sudo apt upgrade -y
```

자바가 설치되어 있는지 확인 (없다면 설치 진행)
```
[ec2-user ~]$ java -version
```

```
[ec2-user ~]wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key |sudo gpg --dearmor -o /usr/share/keyrings/jenkins.gpg
[ec2-user ~]$ sudo sh -c 'echo deb [signed-by=/usr/share/keyrings/jenkins.gpg] http://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list'
[ec2-user ~]$ sudo apt update
[ec2-user ~]$ sudo apt install jenkins
```

Jenkins 실행
```
[ec2-user ~]$ systemctl start jenkins.service
[ec2-user ~]$ systemctl status jenkins
```
$ {ec2 public ip주소}:8080 으로 접속 시 젠킨스 화면 확인 가능

비밀번호는 ec2에서 cat 명령어를 통해 볼 수 있다.
```
sudo cat /var/lib/jenkins/secrets/initialAdminPassword
```
비밀번호 입력 후 뜨는 화면에서 추천하는 플러그인들을 설치한다

<br>
<br>


### Docker 설치

[Docker 공식 문서](https://docs.docker.com/engine/install/ubuntu/)
&nbsp;&nbsp;
[참고 블로그](https://velog.io/@haeny01/AWS-EC2-X-Docker)

apt 업데이트
```
[ec2-user ~]$ sudo apt update
```

apt HTTPS 설정
apt가 HTTPS를 통해 패키지를 사용할 수 있도록 하는 몇 가지 필수 구성 요소 패키지를 설치
```
[ec2-user ~]$ sudo apt install apt-transport-https ca-certificates curl software-properties-common
```

<br>

도커 GPG키 설정
<br>
> GPG? <br>
> 개인간, 머신간 또는 개인-머신간에 교환되는 메시지나 파일을 암호화 하거나 서명을 추가하여 작성자를 확인하고 변조유무를 식별할 수 있게 해주는 도구 <br>
> 기본적으로 RSA와 같은 공개 키 암호화 방식을 사용하여 종단간 파일이나 메시지를 암호화 하거나 서명하는 기능을 제공
```
[ec2-user ~]$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```
명령어 입력 시 OK 응답이 오는 것을 확인한다.


<br>

Docker Repository 설치
```
[ec2-user ~]$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
```
apt 업데이트
```
[ec2-user ~]$ sudo apt update
```
우분투 Repo 대신 도커 Repo로 설치하는지 확인
```
[ec2-user ~]$ apt-cache policy docker-ce
```
확인했을 때 다음과 같은 결과로 응답해야 한다.
>docker-ce:
><br>&nbsp;&nbsp;&nbsp;&nbsp;Installed: (none)
><br>&nbsp;&nbsp;&nbsp;&nbsp;Candidate: 5:24.0.7-1~ubuntu.20.04~focal
><br>&nbsp;&nbsp;&nbsp;&nbsp;Version table:

<br>

Docker 설치
```
[ec2-user ~]$ sudo apt install docker-ce
```

Docker 확인
```
[ec2-user ~]$ sudo systemctl status docker
```
결과의 Active 상태에 active(running)을 확인할 수 있다.

<br>

sudo 없이 도커 사용하기 <br>
- 도커 그룹에 사용자 추가하기
    ```
    [ec2-user ~]$ sudo usermod -aG docker ${user}

    ```
    새 그룹 구성원 자격을 적용하기 위해 다음 명령어 작성
    ```
    [ec2-user ~]$ su - ${USER}
    ```
    명령어 입력 시 해당 유저의 암호를 입력한다.
    
- 도커 그룹 확인하기
    ```
    [ec2-user ~]$ id -nG
    ```
    
